//denna filen hanterar API-anrop relaterade till studentresultat där det 
// hämtas från både Canvas och StudentITS databaser


// beroenden
const canvasDB = require("../databases/db_canvas");
const studentITS = require("../databases/db_studentITS");

// hjälpfunktion för att skicka JSON svar
function sendJson(res, status, obj) {
    res.writeHead(status, { "Content-Type": "application/json" });
    res.end(JSON.stringify(obj));
}


// exporterade funktioner
module.exports = {

    handleGetStudentlista(req, res, inlamningsId) {
        try {
            const resultat = canvasDB.getStudentBaseratInlamning(inlamningsId);

            //debugging
            //console.log('DB rows for inlamningsId', inlamningsId, resultat); 

            const lista = resultat.map(row => {
                // här använder vi STUDENTID direkt
                const person = studentITS.getPersnummerByUsername(row.studentid);

                return {
                    namn: row.namn,
                    personnummer: person?.personnummer || "saknas",
                    canvasBetyg: row.betyg,
                    examinationsdatum: row.examinationsdatum,
                    ladokBetyg: null
                };
            });

            return sendJson(res, 200, lista);

        } catch (err) {
            console.error("handleGetStudentlista error:", err);
            return sendJson(res, 500, { error: "Serverfel" });
        }
    }

};