

//testdatabas flera
const Database = require('better-sqlite3');
const http = require('http');

const db = new Database('canvas-databas.db');

// skapa databas
db.exec(`
  CREATE TABLE IF NOT EXISTS kurs (
    kurskod TEXT PRIMARY KEY,
    kursnamn TEXT
  );
  CREATE TABLE IF NOT EXISTS inlamning (
    inlamningsid INTEGER PRIMARY KEY AUTOINCREMENT,
    kurskod TEXT NOT NULL,
    titel TEXT,
    modulkod TEXT,
    examinationsdatum TEXT,
    FOREIGN KEY (kurskod) REFERENCES kurs(kurskod)
  );
  CREATE TABLE IF NOT EXISTS student (
    studentid TEXT PRIMARY KEY,
    namn TEXT NOT NULL
  );
  CREATE TABLE IF NOT EXISTS student_inlamning (
    studentid TEXT,
    inlamningsid INTEGER,
    betyg TEXT NOT NULL CHECK (betyg IN ('U', 'G')),
    PRIMARY KEY (studentid, inlamningsid),
    FOREIGN KEY (studentid) REFERENCES student(studentid),
    FOREIGN KEY (inlamningsid) REFERENCES inlamning(inlamningsid)
  );
`);

//testdata kurs
let count = db.prepare("SELECT COUNT(*) AS c FROM kurs").get().c;

if (count === 0) {
    db.prepare(`
        INSERT INTO kurs (kurskod, kursnamn)
        VALUES
            ('DB101', 'Databasteknik 101'),
            ('DB102', 'Databasteknik 102'),
            ('DB103', 'Databasteknik 103'),
            ('DB104', 'Databasteknik 104')
    `).run();
}


//testdata inlamning
count = db.prepare("SELECT COUNT(*) AS c FROM inlamning").get().c;
if (count === 0) {
    db.prepare(`
        INSERT INTO inlamning (kurskod, titel, modulkod, examinationsdatum)
        VALUES
            ('DB101', 'Inl채mning 1', '005', '2025-11-03'),
            ('DB101', 'Inl채mning 2', '005', '2025-12-01'),
            ('DB102', 'Inl채mning 1', '006', '2025-11-10'),
            ('DB103', 'Inl채mning 1', '007', '2025-11-17')
    `).run();
}

//testdata student
count = db.prepare("SELECT COUNT(*) AS c FROM student").get().c;
if (count === 0) {
    db.prepare(`
        INSERT INTO student (studentid, namn)
        VALUES
            ('sveedz-4', 'Leroy Jenkins'),
            ('karlk-3', 'Karl Karlsson'),
            ('kn222bi', 'Nisse Nilsson')
    `).run();
}

//testdata student_inlamning
count = db.prepare("SELECT COUNT(*) AS c FROM student_inlamning").get().c;
if (count === 0) {
    db.prepare(`
        INSERT INTO student_inlamning (studentid, inlamningsid, betyg)
        VALUES
            ('sveedz-4', 1, 'G'),
            ('sveedz-4', 2, 'U'),
            ('karlk-3', 1, 'G'),
            ('karlk-3', 3, 'G'),
            ('kn222bi', 4, 'U'),
            ('kn222bi', 2, 'G'),
            ('kn222bi', 3, 'G')
    `).run();
}





module.exports = {

    getAllKurser() {
        return db.prepare(`SELECT kurskod, kursnamn FROM kurs`).all();
    },

    getInlamningarForKurs(kurskod) {
        return db.prepare(`
            SELECT inlamningsid, titel
            FROM inlamning
            WHERE kurskod = ?
        `).all(kurskod);
    },

    getStudentBaseratInlamning(inlamningsid) {
    return db.prepare(`
        SELECT
            s.studentid,
            s.namn,
            si.betyg,
            si.inlamningsid,
            i.examinationsdatum
        FROM student_inlamning si
        JOIN student s ON s.studentid = si.studentid
        JOIN inlamning i ON i.inlamningsid = si.inlamningsid
        WHERE si.inlamningsid = ?
    `).all(inlamningsid);
},

    getInlamningarByModulkod(modulkod) {
    return db.prepare(`
        SELECT inlamningsid, titel
        FROM inlamning
        WHERE modulkod = ?
    `).all(modulkod);
    },

    getUsernameByStudentId(id) {
    return db.prepare(`
        SELECT username
        FROM student
        WHERE studentid = ?
    `).get(id);
    }


};
console.log(db.prepare("SELECT * FROM inlamning").all());

