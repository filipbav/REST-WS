//testdatabas flera
const Database = require('better-sqlite3');
const http = require('http');

const db = new Database('canvas-databas.db');

// skapa databas
db.exec(`
  CREATE TABLE IF NOT EXISTS kurs (
    kurskod TEXT PRIMARY KEY,
    kursnamn TEXT
  );
  CREATE TABLE IF NOT EXISTS inlamning (
    inlamningsid INTEGER PRIMARY KEY AUTOINCREMENT,
    kurskod TEXT NOT NULL,
    titel TEXT,
    modulkod TEXT,
    FOREIGN KEY (kurskod) REFERENCES kurs(kurskod)
  );
  CREATE TABLE IF NOT EXISTS student (
    studentid INTEGER PRIMARY KEY AUTOINCREMENT,
    namn TEXT NOT NULL
  );
  CREATE TABLE IF NOT EXISTS student_inlamning (
    studentid INTEGER,
    inlamningsid INTEGER,
    betyg TEXT NOT NULL CHECK (betyg IN ('U', 'G')),
    PRIMARY KEY (studentid, inlamningsid),
    FOREIGN KEY (studentid) REFERENCES student(studentid),
    FOREIGN KEY (inlamningsid) REFERENCES inlamning(inlamningsid)
  );
`);

// testdata
const kursExists = db.prepare("SELECT 1 FROM kurs WHERE kurskod = ?").get('DB101');
if (!kursExists) {
    db.prepare('INSERT INTO kurs (kurskod, kursnamn) VALUES (?, ?)').run('DB101', 'Databasteknik 101');
}
const inlExists = db.prepare("SELECT 1 FROM inlamning WHERE kurskod = ?").get('DB101');
if (!inlExists) {
    db.prepare('INSERT INTO inlamning (kurskod, titel, modulkod) VALUES (?, ?, ?)').run('DB101', 'Inl√§mning 1', '005');
}
const studentExists = db.prepare("SELECT 1 FROM student WHERE namn = ?").get('TestStudent');
if (!studentExists) {
    db.prepare('INSERT INTO student (namn) VALUES (?)').run('TestStudent');
}
const studentInlExists = db.prepare("SELECT 1 FROM student_inlamning WHERE studentid = ? AND inlamningsid = ?").get(1, 1);
if (!studentInlExists) {
    db.prepare('INSERT INTO student_inlamning (studentid, inlamningsid, betyg) VALUES (?, ?, ?)').run(1, 1, 'G');
}

module.exports = {

    getAllKurser() {
        return db.prepare(`SELECT kurskod, kursnamn FROM kurs`).all();
    },

    getInlamningarForKurs(kurskod) {
        return db.prepare(`
            SELECT inlamningsid, titel
            FROM inlamning
            WHERE kurskod = ?
        `).all(kurskod);
    },

    getStudentBaseratInlamning(inlamningsid) {
        return db.prepare(`
            SELECT
                s.studentid,
                s.namn,
                si.betyg,
                si.inlamningsid
            FROM student_inlamning si
            JOIN student s ON s.studentid = si.studentid
            WHERE si.inlamningsid = ?
        `).all(inlamningsid);
    },

    getInlamningarByModulkod(modulkod) {
    return db.prepare(`
        SELECT inlamningsid, titel
        FROM inlamningar
        WHERE modulkod = ?
    `).all(modulkod);
    }


};
